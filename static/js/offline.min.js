var offline=angular.module("offline",["ngRoute","ui.bootstrap","ngSanitize","smart-table"]);offline.filter("toTimeFilter",function(){return function(a){var b;if(a){var c,d,e;e=parseInt(a/60),c=10>e?"0"+e.toString():e.toString(),d=a%60==30?":30":":00",b=c+d}return b}}),offline.filter("M2MFilter",function(){return function(a,b){var c="";if(a)for(var d=0;d<a.length;d++)for(var e=0;e<b.length;e++)a[d]==b[e].id&&(c=c+b[e].name+" ");return c}}),offline.filter("groupFilter",function(){return function(a,b){var c="";if(a)for(var d=0;d<b.length;d++)if(a==b[d].id){c=b[d].name;break}return c}}),offline.filter("true_false",function(){return function(a){return a?"√":"×"}}),offline.filter("oneFilter",function(){return function(a,b){var c="";if(a&&b)for(var d=0;d<b.length;d++)if(b[d].id==a){c=b[d].name;break}return c}}),offline.filter("company_take",function(){var a={t:"启用",f:"禁用"};return function(b){return b?a[b]:void 0}}),offline.filter("pay_type",function(){var a={cash:"现金",card:"刷卡",mypay:"会员卡",own:"签单",tenpay:"微信",tenpay_back:"微信退款",alipay:"支付宝",coupon:"优惠券",tenpay_coupon:"电子券",gift:"赠送",omit:"抹零",others:"其它"};return function(b){return b?a[b]:void 0}}),offline.filter("gender_state",function(){var a={m:"男",f:"女"};return function(b){return b?a[b]:void 0}}),offline.filter("table_state",function(){var a={t:"正常",f:"停用"};return function(b){return b?a[b]:void 0}}),offline.filter("product_state",function(){var a={t:"上架",f:"下架"};return function(b){return b?a[b]:void 0}}),offline.filter("product_limit",function(){var a={"in":"堂食",out:"外卖",all:"不限"};return function(b){return b?a[b]:void 0}}),offline.filter("product_tstate",function(){var a={t:"是",f:"否"};return function(b){return b?a[b]:void 0}}),offline.filter("product_tstate_s",function(){var a={t:"Х",f:""};return function(b){return b?a[b]:void 0}}),offline.filter("product_nstate",function(){var a={t:"是",f:"否"};return function(b){return b?a[b]:void 0}}),offline.filter("product_pstate",function(){var a={t:"是",f:"否"};return function(b){return b?a[b]:void 0}}),offline.filter("product_pstate_s",function(){var a={t:"√",f:""};return function(b){return b?a[b]:void 0}}),offline.filter("order_state",function(){var a={pre_tenpay:"微信待支付订单",todo:"客户自助下单",confirm:"已审核",cancel:"已取消"};return function(b){return b?a[b]:void 0}}),offline.filter("order_type",function(){var a={"in":"堂食",out:"外卖",in_out:"外带",waste:"丢弃",myeat:"自用",renew:"补单"};return function(b){return b?a[b]:void 0}}),offline.filter("orderline_state",function(){var a={draft:"待处理",printed:"备菜中",sent:"已上菜",cancel:"已取消"};return function(b){return b?a[b]:void 0}}),offline.filter("linecancel_state",function(){var a={normal:"正常",cancelled:"已退"};return function(b){return b?a[b]:void 0}}),offline.filter("ordermoney_state",function(){var a={t:"已付",f:"待付"};return function(b){return b?a[b]:void 0}}),offline.filter("ko_groupbyFilter",function(){return function(a,b){var c=[];if(b||(b=3),a)for(var d=0;d<a.length;d++){for(var e=!0,f=0;f<c.length;f++)if(a[d].id==c[f].id&&c[f].lines.length<b){c[f].lines.push(a[d]),e=!1;break}e&&c.push({id:a[d].id,name:a[d].name,lines:[a[d]]})}return c}}),offline.filter("ko_pcategFilter",function(){return function(a,b){var c=[];if(a){if(b){c=[];for(var d=0;d<a.length;d++)a[d].categ_id&&b==a[d].categ_id&&c.push(a[d]);return c}return a}}}),offline.filter("ko_tableFilter",function(){return function(a,b){if(a&&b){for(var c=[],d=0;d<a.length;d++)if(a[d].code){var e=a[d].code.toString();e.match(b)&&c.push(a[d])}return c}return a}}),offline.filter("ko_productFilter",function(){return function(a,b){if(a&&b){for(var c=[],d=0;d<a.length;d++)if(a[d].code){var e=a[d].code.toString();e.match(b)&&c.push(a[d])}return c}return a}}),offline.filter("ko_zeroQtyFilter",function(){return function(a){if(a){for(var b=[],c=0;c<a.length;c++)a[c].qty>0&&b.push(a[c]);return b}return a}}),offline.directive("ngPrint",function(){function a(a,c,d){c.on("click",function(){var a=document.getElementById(d.printElementId);if(a){var c=a.cloneNode(!0);b.appendChild(c),window.print(),b.innerHTML=""}})}var b=document.getElementById("printSection");return b||(b=document.createElement("div"),b.id="printSection",document.body.appendChild(b)),{link:a,restrict:"A"}}),offline.directive("csSelect",function(){return{require:"^stTable",template:'<input type="checkbox" style="width:1.5rem;height:1.5rem;"/>',scope:{row:"=csSelect"},link:function(a,b,c,d){b.bind("change",function(){a.$apply(function(){d.select(a.row,"multiple")})}),a.$watch("row.isSelected",function(a){a===!0?b.parent().addClass("st-selected"):b.parent().removeClass("st-selected")})}}}),offline.directive("koBuy",["$timeout",function(a){return{restrict:"CA",link:function(b,c){c.bind("click",function(){c.addClass("animated bounce"),a(function(){c.removeClass("animated bounce")},1e3)})}}}]),offline.directive("checklistModel",["$parse","$compile",function(a,b){function c(a,b){if(angular.isArray(a))for(var c=0;c<a.length;c++)if(angular.equals(a[c],b))return!0;return!1}function d(a,b){a=angular.isArray(a)?a:[];for(var c=0;c<a.length;c++)if(angular.equals(a[c],b))return a;return a.push(b),a}function e(a,b){if(angular.isArray(a))for(var c=0;c<a.length;c++)if(angular.equals(a[c],b)){a.splice(c,1);break}return a}function f(f,g,h){b(g)(f);var i=a(h.checklistModel),j=i.assign,k=a(h.checklistValue)(f.$parent);f.$watch("checked",function(a,b){if(a!==b){var c=i(f.$parent);a===!0?j(f.$parent,d(c,k)):j(f.$parent,e(c,k))}}),f.$parent.$watch(h.checklistModel,function(a){f.checked=c(a,k)},!0)}return{restrict:"A",priority:1e3,terminal:!0,scope:!0,compile:function(a,b){if("INPUT"!==a[0].tagName||!a.attr("type","checkbox"))throw'checklist-model should be applied to `input[type="checkbox"]`.';if(!b.checklistValue)throw"You should provide `checklist-value`.";return a.removeAttr("checklist-model"),a.attr("ng-model","checked"),f}}}]),offline.directive("koKey",function(){return{scope:{inputData:"=koInput"},link:function(a,b,c){b.bind("click",function(){var b;b="0"==a.inputData||"00"==a.inputData?"":a.inputData;var d=c.koKey;if("-"==d)a.inputData="-"==b[0]?b.substring(1):"-"+b;else if("del"==d){var e=b.length;a.inputData=b.substring(0,e-1)}else"clr"==d||"do"==d||(a.inputData=b+d)})}}}),offline.directive("koneed",function(){return{link:function(a,b){var c='<span style="color:red;">*</span>';b.append(c)}}}),offline.factory("dbService",["$q","$window",function(a,b){function c(){var c=a.defer();if(d)return c.resolve(!0),c.promise;var g=b.indexedDB.open("offline",e);return g.onerror=function(a){console.log("Error opening db"),c.reject(a.toString())},g.onupgradeneeded=function(a){f=a.target.result,f.objectStoreNames.contains("order")||f.createObjectStore("order",{keyPath:"id"})},g.onsuccess=function(a){f=a.target.result,f.onerror=function(a){c.reject("Database error: "+a.target.errorCode)},d=!0,c.resolve(!0)},c.promise}var d=!1,e=2,f=null,g=function(b){var d=a.defer();return c().then(function(){var a={id:b,saveDate:(new Date).getTime()},c=f.transaction(["order"],"readwrite"),e=c.objectStore("order"),g=e.add(a);g.onsuccess=function(){d.resolve(!0)}}),d.promise},h=function(){var b=a.defer();return c().then(function(){var a={},c=function(b){var c=b.target.result;if(c){var d=c.value.id;a.hasOwnProperty(d)||(a[d]=!0),c["continue"]()}},d=f.transaction(["order"],"readonly"),e=d.objectStore("order");e.openCursor().onsuccess=c,d.oncomplete=function(){b.resolve(a)}}),b.promise},i=function(){var b=a.defer();return c().then(function(){var a=(new Date).getTime(),c=a-864e5,d=f.transaction(["order"],"readonly"),e=d.objectStore("order"),g=[];e.openCursor().onsuccess=function(a){var b=a.target.result;b&&(b.value.saveDate<c&&g.push(b.value.id),b["continue"]())};for(var h=f.transaction(["order"],"readwrite"),i=h.objectStore("order"),j=0;j<g.length;j++)i["delete"](g[j]);h.oncomplete=function(){b.resolve()}}),b.promise};return{saveOrder:g,getAllOrders:h,deleteOldOrders:i}}]),offline.factory("baseService",["$q","$http",function(a,b){var c=null,d=null,e=[],f=[],g=null,h=[],i=[],j=[],k=[],l=null,m=[],n=[],o=[],p=[],q=[],r=[],s=[],t=[],u=null,v=[],w=function(){var d=a.defer();return c?d.resolve(c):b.get("/company/getavailpay").success(function(a){a.error?d.reject(a.error):(c=a.value,d.resolve(c))}).error(function(){d.reject("网络错误")}),d.promise},x=function(){var c=a.defer();return d?c.resolve(d):b.get("/company/getplus").success(function(a){a.error?c.reject(a.error):(d=a.value,c.resolve(d))}).error(function(){c.reject("网络错误")}),c.promise},y=function(){var c=a.defer();return e.length>0?c.resolve(e):b.get("/tcateg/getall").success(function(a){a.error?c.reject(a.error):(e=a.value,c.resolve(e))}).error(function(){c.reject("网络错误")}),c.promise},z=function(){var c=a.defer();return f.length>0?c.resolve(f):b.get("/table/getall").success(function(a){a.error?c.reject(a.error):(f=a.value,c.resolve(f))}).error(function(){c.reject("网络错误")}),c.promise},A=function(){var c=a.defer();return g?c.resolve(g):b.get("/table/getstatus").success(function(a){a.error?c.reject(a.error):(g=a.value,c.resolve(g))}).error(function(){c.reject("网络错误")}),c.promise},B=function(){var c=a.defer();return h.length>0?c.resolve(h):b.get("/products/getall").success(function(a){if(a.error)c.reject(a.error);else{var b=a.value;c.resolve(b)}}).error(function(){c.reject("网络错误")}),c.promise},C=function(){var c=a.defer();return i.length>0?c.resolve(i):b.get("/ppcategs/getall").success(function(a){a.error?c.reject(a.error):(i=a.value,c.resolve(i))}).error(function(){c.reject("网络错误")}),c.promise},D=function(){var c=a.defer();return j.length>0?c.resolve(j):b.get("/pscategs/getall").success(function(a){a.error?c.reject(a.error):(j=a.value,c.resolve(j))}).error(function(){c.reject("网络错误")}),c.promise},E=function(){var c=a.defer();return k.length>0?c.resolve(k):b.get("/ptreats/getall").success(function(a){a.error?c.reject(a.error):(k=a.value,c.resolve(k))}).error(function(){c.reject("网络错误")}),c.promise},F=function(){var c=a.defer();return l?c.resolve(l):b.get("/product/getstatus").success(function(a){a.error?c.reject(a.error):(l=a.value,c.resolve(l))}).error(function(){c.reject("网络错误")}),c.promise},G=function(){var c=a.defer();return m.length>0?c.resolve(m):b.get("/delivery/getall").success(function(a){a.error?c.reject(a.error):(m=a.value,c.resolve(m))}).error(function(){c.reject("网络错误")}),c.promise},H=function(){var c=a.defer();return n?c.resolve(n):b.get("/groups/getall").success(function(a){a.error?c.reject(a.error):(n=a.value.groups,c.resolve(n))}).error(function(){c.reject("网络错误")}),c.promise},I=function(){var c=a.defer();return o.length>0?c.resolve(o):b.get("/head/allcompanies").success(function(a){a.error?c.reject(a.error):(o=a.value,c.resolve(o))}).error(function(){c.reject("网络错误")}),c.promise},J=function(){var c=a.defer();return p.length>0?c.resolve(p):b.get("/head/cgroup/getall").success(function(a){a.error?c.reject(a.error):(p=a.value,c.resolve(p))}).error(function(){c.reject("网络错误")}),c.promise},K=function(){var c=a.defer();return q.length>0?c.resolve(q):b.get("/head/hproducts/getall").success(function(a){if(a.error)c.reject(a.error);else{var b=a.value;c.resolve(b)}}).error(function(){c.reject("网络错误")}),c.promise},L=function(){var c=a.defer();return r.length>0?c.resolve(r):b.get("/head/hppcategs/getall").success(function(a){a.error?c.reject(a.error):(r=a.value,c.resolve(r))}).error(function(){c.reject("网络错误")}),c.promise},M=function(){var c=a.defer();return s.length>0?c.resolve(s):b.get("/head/hpscategs/getall").success(function(a){a.error?c.reject(a.error):(s=a.value,c.resolve(s))}).error(function(){c.reject("网络错误")}),c.promise},N=function(){var c=a.defer();return t.length>0?c.resolve(t):b.get("/head/ptreats/getall").success(function(a){a.error?c.reject(a.error):(t=a.value,c.resolve(t))}).error(function(){c.reject("网络错误")}),c.promise},O=function(){var c=a.defer();return u?c.resolve(u):b.get("/head/hproduct/getstatus").success(function(a){a.error?c.reject(a.error):(u=a.value,c.resolve(u))}).error(function(){c.reject("网络错误")}),c.promise},P=function(){var c=a.defer();return v.length>0?c.resolve(v):b.get("/head/hprice/getall").success(function(a){a.error?c.reject(a.error):(v=a.value,c.resolve(v))}).error(function(){c.reject("网络错误")}),c.promise};return{getPlusInfo:x,getPayType:w,getTables:z,getTCategs:y,getTableStatus:A,getProducts:B,getPpcategs:C,getPscategs:D,getPtreats:E,getPstatus:F,getUgroups:H,getDelivery:G,getCompanies:I,getCgroups:J,getHProducts:K,getHPpcategs:L,getHPscategs:M,getHPtreats:N,getHPstatus:O,getHPrice:P}}]),offline.config(["$httpProvider","$routeProvider",function(a,b){a.defaults.cache=!1,a.defaults.headers.get||(a.defaults.headers.get={}),a.defaults.headers.get["If-Modified-Since"]="0",b.when("/",{controller:"ServiceChinesePosCtrl",templateUrl:"../static/templates/offline_pos_chinese.html"}),b.when("/pos/chinese",{controller:"ServiceChinesePosCtrl",templateUrl:"../static/templates/offline_pos_chinese.html"}),b.when("/pos/kproduct",{controller:"KProductListCtrl",templateUrl:"../static/templates/offline_product_list.html"}),b.when("/pos/today",{controller:"OrderTodayCtrl",templateUrl:"../static/templates/offline_order_today.html"}),b.when("/pos/done",{controller:"OrderlineListDoneCtrl",templateUrl:"../static/templates/offline_orderline_list_done.html"}),b.when("/pos/prepare",{controller:"OrderlineListPrepareCtrl",templateUrl:"../static/templates/offline_orderline_list_prepare.html"}),b.otherwise({redirectTo:"/"})}]),offline.controller("BaseCtrl",["$scope","$route","$http","$modal","$window","$document","$timeout","$q","dbService",function(a,b,c,d,e,f,g,h,i){"use strict";a.offline=!1,a.offlineSource=null,a.offlineOrigin=null,a.hasOfflinePcateg=!1,a.hasOfflineProduct=!1,a.hasOfflinePtreat=!1,a.hasOfflineTable=!1,a.hasOfflinePay=!1;var j,k,l={};e.addEventListener("message",function(b){a.offline=!0,a.offlineSource=b.source,a.offlineOrigin=b.origin,j=b.source,k=b.origin;var d=n();if(j.postMessage(JSON.stringify({height:d}),k),j.postMessage(JSON.stringify({check:"ok"}),k),b.data){var e=JSON.parse(b.data);c.get("/company/info").success(function(a){j.postMessage(JSON.stringify({info:a.value}),k)}),e.check&&(i.deleteOldOrders(),m())}},!1);var m=function(){var a=c.get("/order/download"),b=i.getAllOrders();h.all([a,b]).then(function(a){var b=a[0].data.value,d=a[1];if(b.length>0){for(var e=[],f=0;f<b.length;f++){var h=b[f].id;e.push(h),d.hasOwnProperty(h)||l.hasOwnProperty(h)||(j.postMessage(JSON.stringify({order:b[f]}),k),l[h]=!0,i.saveOrder(h))}c.post("/order/download/done",e)}g(m,3e4)})},n=function(){return f[0].body.scrollHeight};a.$watch(n,function(){if(a.offline){var b=n();j.postMessage(JSON.stringify({height:b}),k)}}),a.access=[],a.bc="",a.showMenu=!0,a.showBc=!1,a.$parent.err="",a.closeError=function(){a.err=""},a.closeMenu=function(){a.showMenu=!1},a.openMenu=function(){a.showMenu=!0},a.actionBack=function(){e.history.back()},a.actionExit=function(){var a=function(a,c){a.ok=function(){e.location="/user/logout",b.reload(),c.close()},a.cancel=function(){c.dismiss()}};a.$inject=["$scope","$modalInstance"];d.open({templateUrl:"action_exit.html",controller:a,size:"lg"})}}]),offline.controller("DashboardCtrl",["$scope","$route","$http",function(a){a.access=[],a.$parent.bc="欢迎使用客多点管理系统",a.$parent.showBc=!1,a.$parent.err=""}]),offline.controller("ServiceChinesePosCtrl",["$q","$timeout","$filter","$scope","$location","$route","$http","$routeParams","$modal","baseService",function(a,b,c,d,e,f,g,h,i,j){"use strict";var k,l;d.$parent.bc=" 中餐点餐",d.$parent.showBc=!1,d.$parent.showMenu=!1,d.search={tableCode:""},d.takeaway={orders:[],color:"btn-default"},d.show={table:!0,operate:!1,shift:!1};var m=function(a){g.post("/order/print",a)},n=function(a){g.post("/order/print/table",a)},o=function(a){for(var b=0;b<a.length;b++){for(var c=0;c<a[b].lines.length;c++)""===a[b].lines[c].line_id&&delete a[b].lines[c].line_id,""===a[b].lines[c].id&&delete a[b].lines[c].id,""===a[b].lines[c].order_id&&delete a[b].lines[c].order_id,""===a[b].lines[c].table_id&&delete a[b].lines[c].table_id;for(var d=0;c<a[d].pays.length;d++)""===a[b].pays[d].id&&delete a[b].pays[d].id,""===a[b].pays[d].create_id&&delete a[b].pays[d].create_id;""===a[b].id&&delete a[b].id,""===a[b].preorder_id&&delete a[b].preorder_id,""===a[b].table_id&&delete a[b].table_id,""===a[b].pos_id&&delete a[b].pos_id}g.post("/order/print/receipt",a)};d.cartProducts=[];var p=function(a){for(var b=0,c=0;c<a.lines.length;c++){var d=a.lines[c].qty-a.lines[c].cancel_qty-a.lines[c].return_qty,e=d*a.lines[c].price*a.lines[c].discount/100;b+=e}return b},q=function(a){d.show.table=!1,d.show.operate=!0,d.show.shift=!1,d.operate_table=a,a.has_new=!1},r=function(){d.show.table=!0,d.show.operate=!1,d.show.shift=!1},s=function(){d.show.table=!1,d.show.operate=!1,d.show.shift=!0},t=function(){d.show.table=!0,d.show.operate=!1,d.show.shift=!1},u=function(a,b){for(var c=0;c<d.tables.length;c++)if(d.tables[c].id==a){for(var e=!1,f=0;f<d.tables[c].orders.length;f++)if(d.tables[c].orders[f].name==b.name){e=!0;break}e||d.tables[c].orders.push(b);break}},v=function(a){var b;if(a.orders.length>0)for(var c=0;c<a.orders.length;c++){b=a.orders[0].ref?a.orders[0].ref:a.orders[0].name;break}return b};d.actionPrintOrder=function(a){n(a)},d.actionPrintTable=function(a){for(var b=0;b<a.orders.length;b++)n(a.orders[b])},d.actionPostOrder=function(a,b){var c={};c.person_qty=a.busy_qty,c.ref=v(a),c.note=d.note,c.lines=b,c.order_type="in",c.table_id=a.id,c.has_pay=!1,d.paying=!0,g.post("/table/"+a.id+"/order",c).success(function(b){b.error?(d.$parent.$parent.err=b.error,d.paying=!1):(c.name=b.value,u(a.id,c),m(c),a.is_busy=!0,f.reload()),d.paying=!1}).error(function(){d.$parent.$parent.err="网络错误",d.paying=!1})},j.getPlusInfo().then(function(a){d.plusInfo=a}),j.getTCategs().then(function(a){d.tcategs=a}),j.getTables().then(function(a){d.tables=[].concat(a);for(var b=0;b<d.tables.length;b++)d.tables[b].color="btn-default",d.tables[b].orders=[];d.tempTables=d.tables,z()}),j.getPscategs().then(function(a){d.pcategs=a}),j.getProducts().then(function(a){d.products=a,d.tempProducts=d.products}),d.actionTakeaway=function(){e.path("/orders/out/start")},d.actionTable=function(a){a.is_busy?q(a):A(a)},d.actionClose=function(){r()},d.actionTCateg=function(a){d.tempTables=c("ko_pcategFilter")(d.tables,a)},d.actionPCateg=function(a){d.tempProducts=c("ko_pcategFilter")(d.products,a)},d.actionProduct=function(a){var b=a.price,c=!0,e=d.cartProducts&&d.cartProducts.length||0;e>0&&0===d.cartProducts[e-1].treat.length&&d.cartProducts[e-1].id===a.id&&(c=!1,d.cartProducts[e-1].qty+=1),c&&d.cartProducts.push({id:a.id,name:a.name,price:b,qty:1,treat:[],discount:100})},d.actionDelProduct=function(a){for(var b=[],c=d.cartProducts.length,e=0;c>e;e++){var f=c-a-1;e!=f&&b.push(d.cartProducts[e])}d.cartProducts=b},d.actionTreat=function(a){var b=d.cartProducts.length;d.cartProducts[b-1].treat.push(a)},d.removeTreat=function(){var a=d.cartProducts.length;d.cartProducts[a-1].treat=[]},d.$watch("search.tableCode",function(){d.tempTables=c("ko_tableFilter")(d.tables,d.search.tableCode)}),d.actionClear=function(){d.tempTables=d.tables,d.search.tableCode=""};var w=function(a){for(var b=0;b<d.takeaway.orders.length;b++)if("todo"==d.takeaway.orders[b].state){d.takeaway.color="btn-warning";break}for(var c=0;c<a.length;c++)if(a[c].orders.length>0){a[c].color="btn-info";for(var e=0;e<a[c].orders.length;e++)if("todo"==a[c].orders[e].state){a[c].color="btn-warning";break}}},x=function(a,b){for(var c=0;c<a.length;c++)if(a[c].table_id){for(var e=0;e<d.tables.length;e++)if(a[c].table_id==d.tables[e].id){for(var f=!1,g=0;g<d.tables[e].orders.length;g++)if(d.tables[e].orders[g].name==a[c].name){f=!0;break}f||(d.tables[e].orders.push(a[c]),b||(d.tables[e].has_new=!0));break}}else d.takeaway.orders.push(a[c])},y=function(b){var c,d=a.defer();return b&&(c={last_time:b}),g.get("/orders/get_todo",{params:c}).success(function(a){a.error?d.reject(a.error):d.resolve(a.value)}).error(function(){d.reject("网络错误")}),d.promise},z=function(){y(k).then(function(a){a||(a=[]);var e;k||(e=!0),a=c("orderBy")(a,"-create_date"),a.length>0&&(k=a[0].create_date,x(a,e),w(d.tables)),b(z,5e3)})},A=function(a){var b=function(a,b,c){a.tempPersonQty="",a.actionPersonQtyCancel=function(){b.dismiss("cancel")},a.actionPersonQtyOk=function(a){var d=parseInt(a);b.close([c,d])}};b.$inject=["$scope","$modalInstance","table"];var c=i.open({templateUrl:"action_open.html",controller:b,size:"lg",resolve:{table:function(){return a}}});c.result.then(function(a){var b=a[0].id,c=a[1];g.get("/table/"+b+"/start",{params:{person_qty:c}}).success(function(a){if(a.error)alert(a.error);else for(var e=0;e<d.tables.length;e++)d.tables[e].id==b&&(d.tables[e].busy_qty=c,d.tables[e].is_busy=!0,q(d.tables[e]))})},function(a){console.log(a)})};d.actionPerson=function(a){var b=function(a,b,c){a.tempPersonQty="",a.actionPersonQtyCancel=function(){b.dismiss("cancel")},a.actionPersonQtyOk=function(d){var e=parseInt(d);g.get("/table/"+c.id+"/person",{params:{qty:e}}).success(function(a){a.error?alert(a.error):(alert("修改成功"),b.close([c,e]))}).error(function(){a.$parent.$parent.err="网络错误"})}};b.$inject=["$scope","$modalInstance","table"];var c=i.open({templateUrl:"action_person.html",controller:b,size:"lg",resolve:{table:function(){return a}}});c.result.then(function(a){for(var b=a[0].id,c=a[1],e=0;e<d.tables.length;e++)d.tables[e].id==b&&(d.tables[e].busy_qty=c)},function(a){console.log(a)})},d.actionChangeTable=function(a){var b=function(a,b,d,e){d.getTCategs().then(function(b){a.tcategs=b}),d.getTables().then(function(b){a.tables=[].concat(b),a.tempTables=a.tables,z()}),a.actionTCateg=function(b){a.tempTables=c("ko_pcategFilter")(a.tables,b)},a.changeTableCancel=function(){b.dismiss()},a.changeTableOk=function(a){g.get("/order/"+e.id+"/table",{params:{table:a}}).success(function(a){a.error?alert(a.error):(alert("操作成功"),f.reload(),b.close())}).error(function(){console.log("网络错误")})}};b.$inject=["$scope","$modalInstance","baseService","order"];var d=i.open({templateUrl:"action_change_table.html",controller:b,size:"lg",resolve:{order:function(){return a}}});d.result.then(function(){},function(a){console.log(a)})},d.actionConfirm=function(a){g.get("/order/"+a.id+"/confirm").success(function(a){a.error&&alert(a.error),f.reload()}).error(function(){d.$parent.err="网络错误"})},d.actionCancel=function(a){var b=function(a,b,c){a.temp={},a.ok=function(){g.get("/order/"+c.id+"/cancel").success(function(a){a.error?alert(a.error):(b.close(),f.reload())}).error(function(){console.log("网络错误")})},a.cancel=function(){b.dismiss()}};b.$inject=["$scope","$modalInstance","order"];i.open({templateUrl:"action_cancel.html",controller:b,size:"lg",resolve:{order:function(){return a}}})},d.actionReturnOrder=function(a){var b=function(a,b,c){a.order=c,a.ok=function(){g.get("/order/"+c.id+"/return").success(function(a){alert(a.error?a.error:"退单成功!"),b.close(),f.reload()}).error(function(){alert("网络错误")})},a.cancel=function(){b.dismiss()}};b.$inject=["$scope","$modalInstance","order"];i.open({templateUrl:"action_return_order.html",controller:b,size:"lg",resolve:{order:function(){return a}}})},d.actionReturnOne=function(a,b){var c=function(a,b,c,d){a.order=c,a.avail_pays=[];var e=0;if(c.has_pay){for(var h=0;h<c.pays.length;h++)if(!c.pays[h].is_return){var i=c.pays[h].pay_type;if("cash"===i)a.avail_pays.push({id:i,name:"现金"});else if("card"===i)a.avail_pays.push({id:i,name:"银行卡"});else if("own"===i)a.avail_pays.push({id:i,name:"签单"});else if("tenpay"===i)a.avail_pays.push({id:i,name:"微信"});else if("alipay"===i)a.avail_pays.push({id:i,name:"支付宝"});else if("coupon"===i)a.avail_pays.push({id:i,name:"优惠券"});else if("tenpay_coupon"===i)a.avail_pays.push({id:i,name:"微信优惠券"});else if("mypay"===i){var j=c.pays[h].name;a.avail_pays.push({id:i,name:"充值卡",moneyName:j})}}e=d.qty*d.price*d.discount/100}a.cancelProduct={id:d.id,name:d.name,qty:d.qty,money_qty:e,payType:a.avail_pays&&a.avail_pays[0]},a.ok=function(){var e={product_qty:a.cancelProduct.qty};a.cancelProduct.money_qty>0&&(e.money_type=a.cancelProduct.payType.id,e.money_name=a.cancelProduct.payType.moneyName,e.money_qty=a.cancelProduct.money_qty),g.get("/order/"+c.id+"/orderline/"+d.line_id+"/cancel",{params:e}).success(function(a){a.error?alert(a.error):(alert("退品成功"),b.close(),f.reload())}).error(function(){a.$parent.err="网络错误"})},a.cancel=function(){b.dismiss()}};c.$inject=["$scope","$modalInstance","order","line"];i.open({templateUrl:"action_return_one.html",controller:c,size:"lg",resolve:{order:function(){return a},line:function(){return b}}})},d.actionMoney=function(a){var b=function(a,b,c){a.orderlines=[],a.totalprice=0,a.tempMoneyStr="",a.plusInfo={},a.discount=0,a.plusprice=0,a.total=a.totalprice+a.plusprice;var d=function(){return 0===a.plusInfo.plus_state?0:1==a.plusInfo.plus_state?a.plusInfo.plus_calc:2==a.plusInfo.plus_state?a.plusInfo.plus_calc*c.busy_qty:3==a.plusInfo.plus_state?parseInt(a.plusInfo.plus_calc*a.totalprice/100):void 0};j.getPlusInfo().then(function(b){a.plusInfo=b,a.plusprice=d()});for(var e=0;e<c.orders.length;e++){a.totalprice+=p(c.orders[e]);for(var h=0;h<c.orders[e].lines.length;h++)a.orderlines.push(c.orders[e].lines[h]);a.plusprice=d()}a.use={discount:!1,tenpay_coupon:!1,coupon:!1,cash:!0},a.money={cash:0,coupon:0,tenpay_coupon:0,left:0},a.actionReceipt=function(){o(c.orders)};var i=function(){a.discount>0&&a.discount<100?(a.money.left=Math.floor((a.totalprice+a.plusprice)*a.discount/100)-a.money.cash-a.money.coupon-a.money.tenpay_coupon,a.total=Math.floor((a.totalprice+a.plusprice)*a.discount/100)):(a.total=a.totalprice+a.plusprice,a.money.left=a.totalprice+a.plusprice-a.money.cash-a.money.coupon-a.money.tenpay_coupon)};a.$watch("tempMoneyStr",function(){a.use.cash?a.money.cash=parseInt(a.tempMoneyStr):a.use.coupon?a.money.coupon=parseInt(a.tempMoneyStr):a.use.tenpay_coupon?a.money.tenpay_coupon=parseInt(a.tempMoneyStr):a.use.discount&&(a.discount=parseInt(a.tempMoneyStr)),i()}),a.actionTenpayCoupon=function(){a.use.tenpay_coupon=!0,a.use.coupon=!1,a.use.cash=!1,a.use.discount=!1,a.tempMoneyStr=a.money.tenpay_coupon>0?a.money.tenpay_coupon+"":"0"},a.actionCoupon=function(){a.use.tenpay_coupon=!1,a.use.coupon=!0,a.use.cash=!1,a.use.discount=!1,a.tempMoneyStr=a.money.coupon>0?a.money.coupon+"":"0"},a.actionCash=function(){a.use.tenpay_coupon=!1,a.use.coupon=!1,a.use.cash=!0,a.use.discount=!1,a.tempMoneyStr=a.money.cash>0?a.money.cash+"":"0"},a.actionLess=function(){a.plusprice=0,i()},a.actionDiscount=function(){a.use.tenpay_coupon=!1,a.use.coupon=!1,a.use.cash=!1,a.use.discount=!0,a.tempMoneyStr=a.discount+""},a.actionOk=function(){var d,e;e=a.discount>0&&a.discount<100?Math.floor((a.totalprice+a.plusprice)*a.discount/100)-a.money.cash-a.money.coupon-a.money.tenpay_coupon:a.totalprice+a.plusprice-a.money.cash-a.money.coupon-a.money.tenpay_coupon,d=0>e?Math.floor((a.totalprice+a.plusprice)*a.discount/100)-a.money.coupon-a.money.tenpay_coupon:a.money.cash,g.get("/table/"+c.id+"/money",{params:{plus:a.plusprice,discount:a.discount,cash:parseInt(d),coupon:a.money.coupon,tenpay_coupon:a.money.tenpay_coupon}}).success(function(a){a.error?alert(a.error):(b.close(c),c.is_busy=!1,c.busy_qty=0,o(c.orders),alert("结账成功!"),f.reload())}).error(function(){alert("网络错误")})},a.actionCancel=function(){b.dismiss()}};b.$inject=["$scope","$modalInstance","table"];i.open({templateUrl:"action_money.html",controller:b,size:"lg",resolve:{table:function(){return a}}})},d.actionToShift=function(){var a=function(a,b){a.manager={},a.ok=function(){b.close([a.manager])},a.cancel=function(){b.dismiss()}};a.$inject=["$scope","$modalInstance"];var b=i.open({templateUrl:"action_to_shift.html",controller:a,size:"lg"});b.result.then(function(a){B(a)})};var B=function(a){d.allDatas={},d.cash=0,l=(new Date).getTime(),g.get("/orders/check",{params:{manager_name:a[0].name,manager_password:a[0].password}}).success(function(b){if(b.error)alert(b.error);else{{b.value}d.company_info=b.value.company_info,d.order_count=b.value.order_count,d.pays=b.value.pay_result||[],d.return_count=0,d.return_amount=0,d.amount=0,d.cash=0,d.returnPays=[],d.realPays=[],d.manager=a[0];for(var c=0;c<d.pays.length;c++){var e=d.pays[c].qty;d.pays[c]._id.is_return?(d.returnPays.push(d.pays[c]),d.return_count+=1,d.return_amount+=e):(d.realPays.push(d.pays[c]),d.amount+=e)}d.utotalPays={};for(var f=0;f<d.pays.length;f++){var g=d.pays[f]._id.pay_type;d.utotalPays.hasOwnProperty(g)||(d.utotalPays[g]=0),d.utotalPays[g]+=d.pays[f].qty}s()}}).error(function(){d.$parent.err="网络错误"})};d.actionOkShift=function(a){g.get("/orders/shift",{params:{shift_end:l,manager_name:a.name,manager_password:a.password}}).success(function(a){alert(a.error?a.error:"交班完成!")}).error(function(){d.$parent.err="网络错误"}),t(),f.reload()},d.actionCancelShift=function(){t()}}]),offline.controller("OrderTodayCtrl",["$scope","$location","$route","$http","$filter","$routeParams","$modal","baseService",function(a,b,c,d,e,f,g,h){"use strict";a.$parent.bc=" 今日订单",a.$parent.showBc=!0,a.actionAll=function(){a.tempOrders=a.orders},a.actionAllIn=function(){for(var b=[],c=0;c<a.orders.length;c++)("in"==a.orders[c].order_type||"in_out"==a.orders[c].order_type)&&b.push(a.orders[c]);a.tempOrders=b},a.actionAllOut=function(){for(var b=[],c=0;c<a.orders.length;c++)"out"==a.orders[c].order_type&&b.push(a.orders[c]);a.tempOrders=b},h.getTables().then(function(b){a.tables=b}),d.get("/orders/today").success(function(b){if(b.error)a.$parent.err=b.error;else{a.orders=b.value;for(var c=0;c<a.orders.length;c++){a.orders[c].totalprice=0;for(var d=0;d<a.orders[c].lines.length;d++)a.orders[c].totalprice=a.orders[c].totalprice+a.orders[c].lines[d].price*a.orders[c].lines[d].qty}a.tempOrders=[].concat(a.orders)}}).error(function(){console.log("网络错误")}),a.actionDetail=function(a){var b=function(a,b,c){a.order=c,a.cancel=function(){b.dismiss("cancel")}};b.$inject=["$scope","$modalInstance","order"];g.open({templateUrl:"action_detail.html",controller:b,size:"lg",resolve:{order:function(){return a}}})}}]),offline.controller("KProductListCtrl",["$scope","$location","$http","$filter","$routeParams","$route","$modal",function(a,b,c,d,e,f,g){"use strict";a.$parent.bc="商品估清",a.$parent.showBc=!0;e.pageNo;a.$parent.err="",a.products=[],a.pcategs=[],a.selectedPcategs=[],a.states=[],a.temp_states=[],a.new_states=[],a.search={},c.get("/pscategs/getall").success(function(b){b.error?a.$parent.err=b.error:a.pcategs=b.value}).error(function(){a.$parent.err="网络错误"}),c.get("/product/getstatus").success(function(b){if(b.error)a.$parent.err=b.error;else{var c=b.value;a.states=c.states,a.temp_states=c.temp_states,a.new_states=c.new_states}}).error(function(){a.$parent.err="网络错误"}),c.get("/products/0/bulkread").success(function(b){b.error?a.$parent.err=b.error:(a.products=b.value,a.tempProducts=[].concat(a.products))}).error(function(){a.$parent.err="网络错误"}),a.$watch("search.productCode",function(){a.tempProducts=d("ko_productFilter")(a.products,a.search.productCode)}),a.actionClearProduct=function(b){a.tempTables=d("ko_productFilter")(a.products,b),a.search.productCode=""},a.actionPauseSell=function(a){var b=function(a,b,d){a.temp={},a.ok=function(){c.get("/product/"+d+"/disable").success(function(a){alert(a.error?a.error:"停售成功!")}).error(function(){console.log("网络错误")}),f.reload(),b.close()},a.cancel=function(){b.dismiss("cancel")}};b.$inject=["$scope","$modalInstance","productId"];g.open({templateUrl:"action_pause_sell.html",controller:b,size:"lg",resolve:{productId:function(){return a}}})},a.actionReSell=function(a){var b=function(a,b,d){a.temp={},a.ok=function(){c.get("/product/"+d+"/enable").success(function(a){alert(a.error?a.error:"设置成功!")}).error(function(){console.log("网络错误")}),f.reload(),b.close()},a.cancel=function(){b.dismiss("cancel")}};b.$inject=["$scope","$modalInstance","productId"];g.open({templateUrl:"action_re_sell.html",controller:b,size:"lg",resolve:{productId:function(){return a}}})}}]);
//# sourceMappingURL=offline.min.js.map